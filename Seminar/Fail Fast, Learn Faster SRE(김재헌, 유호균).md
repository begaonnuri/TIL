

> 링크 : https://tv.naver.com/v/11211080



## 왜 SRE를 도입해야 하는가(도입 배경)

SRE(Site Reliability Engineering, 사이트 신뢰성 엔지니어링)은 대규모 인터넷 서비스를 제공하면서 어떻게 시스템의 **신뢰성**을 보장할 수 있는지 고민하는 기술 분야, **방법론, 문화**이다.

SRE가 다루고 있는 분야는 많다. SLI, SLO, SLA, Error Budget, DevOps, Post-Mortem, Blameless, Toil management, Silo, Availability, Emergency Response, Capacity Planning, Change Management, On-Call, Monitoring 등

#### 네이버 검색 SRE팀 정의

- 신뢰성 : 네이버 검색 서비스가 정상적으로 제공되는 것
- 방법론 : Availability, Capacity Planning(용량 관리 계획), Monitoring, Contingency Planning(비상 대응 계획)

- 문화 : Post-Mortem(사후 분석), Blameless, Fact-Based

#### SRE가 꼭 필요한 이유

- 네이버 검색은 365일 무중단 제공되어야 한다.
- 서버가 무한히 늘어나지만 사람은 무한히 늘어날 수 없다.
- 기존의 DevOps 방법론으로는 감당할 수 없는 요인(자연재해)이 발생할 수 있다.

중요한것은 도구가 아니라 현실에 닥친 문제를 해결하는 것이다.



## 우리의 SRE(기존의 시스템)

#### 기존 SRE의 문제점

1. 비상상황 대응 체계의 부재

2. 장애 발생 Detection의 어려움

3. Post-Mortem 문화의 부재

4. 전체 시스템을 한눈에 파악할 수 있는 방법론의 부재



## Metric + Meta Data = Insight

### 1. 비상상황 대응 체계의 부재

비상 상황(contingency)이 무엇인지 정의가 없고, 비상 상황에 어떻게 행동해야 하는지 체계가 없었다.

다음과 같이 CP를 정의해서 해결

![image-20201127015425521](/Users/nam/workspace/TIL/Seminar/img/Fail Fast, Learn Faster SRE_1.png)



### 2. 장애 발생 Detection의 어려움

장애를 detection하는 기준이 필요했다.

다음과 같이 가용량 지표를 개발해서 해결

![image-20201127020335597](/Users/nam/workspace/TIL/Seminar/img/Fail Fast, Learn Faster SRE_2.png)

### 3. Post-Mortem 문화의 부재

장애 복구 후 사후 처리 Report가 누락됐고, 비슷한 장애가 재발했을 때 대응 대책이 없었다.

다른 팀에 Post-Mortem 작성 포맷을 공유하고 사후 분석을 습관화 하는 문화를 전파해서 해결

![image-20201127020737013](/Users/nam/workspace/TIL/Seminar/img/Fail Fast, Learn Faster SRE_3.png)



### 4. 전체 시스템 현황 확인 불가

다양한 서비스의 연계 장애 및 전체 현황을 파악할 수 없었다. Detecting을 해서 Alerting을 해야 해서 통합 모니터링 시스템을 만들기로 했다.

Metric과 Meta Data를 통해 인사이트를 얻어야 했다. 2가지 메타 데이터를 이용하기로 했다.

1. 서비스 단위로 정보를 자동으로 모을 수 있는 ID체계 도입
2. 담당자 정보의 정확도를 유지



#### 1. 서비스 단위로 정보를 자동으로 모을 수 있는 ID체계 도입

UUSID(서비스 유니크 아이디)발급해서 모든 계층을 묶어서 가시화했다.

문제가 생겼을 때 호스트 단위가 아니라 서비스 단위로 파악 가능해졌다.

![image-20201127100705918](/Users/nam/workspace/TIL/Seminar/img/Fail Fast, Learn Faster SRE_4.png)



#### 2. 담당자 정보의 정확도를 유지

담당자 정보가 없으면 기본적인 모니터링이 불가능하다.

DRI(서비스 담당자 정보)를 등록해서 강제성을 부여해서 해결했다.

![image-20201127101208420](/Users/nam/workspace/TIL/Seminar/img/Fail Fast, Learn Faster SRE_5.png)



####  3. 장비 환경

일반적으로 prod 환경에 서버를 한 두대 정도 두고 테스트하는데 여기서 정보 왜곡이 발생하면 탐지가 정확해지지 않는다.

환경별로 장비를 둬서 dev장비, stage장비, test장비, prod장비를 분류해서 해결했다.

이로 인해 서비스 전체의 합산 지표가 아닌, 해당 환경(ex prod)의 서비스 합산 지표를 알 수 있게 됐다.

![image-20201203162639498](/Users/nam/workspace/TIL/Seminar/img/Fail Fast, Learn Faster SRE_6.png)



데이터를 뒤엎지 않고 기존의 데이터를 활용하면서 적절한 메타데이터(SSUID, DRI, Environment)를 도입하니 기존에 보지 못했던 인사이트(장애 탐지)가 보이기 시작했다.

위 메타데이터 말고도 비용, 성능 정보 등 다양한 메타데이터를 활용하고 서비스/계층 단위로 Aggregation을 해서 통합 대시보드를 만들 수 있었다. 통합 대시보드를 통해 365일 24시간 검색서비스 전체 관점에서 이상탐지, 가시화, 경보발송을 할 수 있었다.

이전엔 목표가 통합 대시보드를 만드는것이었는데, 통합 대시보드를 만들고 난 뒤 목표가 바뀌었다. 통합 대시보드를 통해 새로운 장애케이스를 발견했고, 장애케이스를 극복하면서 개선해나갔다. 이것이 Fail Fast, Learn Faster



## Fail Fast, Learn Faster

### 어떻게 하면 장애의 영향을 줄일 수 있을까?

장애에 소요되는 시간을 줄이는 것이 중요하다. 장애에 소요되는 시간엔 2가지가 있다.

#### 1. 장애 지속 시간

- 이상 징후 탐지
- 의사 결정
- 복구

#### 2. 사후 처리 시간

- 영향도 파악
- 상세 원인 분석 및 재발 방지

물리적으로 복구, 상세 원인 분석 및 재발 방지 시간은 줄이기가 어려웠다. SRE는 이상 징후 탐지, 의사 결정, 영향도 파악의 시간은 줄일 수 있었다.



#### 이상 징후 탐지 시간 단축

이상 징후 탐지 시간 단축을 위해 경보 빈도를 늘렸다. 하지만 너무 많은 경보가 오다보니 경보 피로가 왔다. 경보를 줄이기 위해 두가지 원칙을 세웠다.

1. 오캄의 면도날 : 조건이 같다면 간단한 것이 더 강력하다.
	- 부하증가배수 > 최대가용배수이면 임계상황이다.
	- 정상 트래픽에서 벗어나면 경보를 발송한다.

2. 하인리히 법칙(1:29:3000) : 대형 사고가 일어나기 전에는 수십차례의 경미한 사고와 수백번의 징후가 일어난다.
	- 적당한 수준의 경보 빈도를 유지하기 위해 즉각적인 대응이 필요하지 않은 경우엔 경보를 보류한다.
	- 거짓 경보를 막기 위해 평일인 공휴일에 통계, 학습값을 적용한다.



트래픽을 자세히 관찰하고, 다양한 경보를 수신하고, 경보가 너무 많아질 때 개선해보니 다양한 일을 할 수 있었다. 그래서 더 Advanced한 SRE에 도전했다.

#### 1. 트래픽 패턴 분석

거짓 경보의 발생 이유를 판단하기 위해 트래픽 패턴을 분석해서 패턴 매칭을 했다.

또한 트래픽을 이전(Migration)하는 과정에서 경보가 발생하면 안되기 때문에 각 버전의 트래픽 합산이 일정하면 알림을 pending하도록 해서 버전 업데이트시 발생하는 거짓 경보를 줄였다.

#### 2. 자동 비상 대응

재난에도 검색 서비스는 안정적으로 동작해야했기 때문에 자동 비상 대응 시스템을 개발했다.

4.0 이상의 지진이 발생하거나 통합 검색 트래픽이 급격히 증가하면 Cache Expire Time을 연장해서 서버 하단 부하를 방지했다.

트래픽이 급증 하기 전에 시스템이 자동화되는 것은 SRE의 궁극적인 목적이다.

#### 3. 부가적인 이득

이전엔 전체 시스템의 장애 영향도를 파악하는데 1시간이 걸렸지만 현황을 파악하기 쉬워지면서 5분으로 줄어들었다.



빠르게 실패하고 개선하면서 장애의 수는 드라마틱하게 줄어들었다.

![image-20201204203927364](/Users/nam/workspace/TIL/Seminar/img/Fail Fast, Learn Faster SRE_7.png)



## Lessons Learned(느낀점)

### 1. SRE ≒ 재난 엔지니어링

`이상 탐지를 자동화 + 경보 압축을 추구` = `시스템 문제점 해결 + 안정적인 시스템 구축` = `재난 엔지니어링`

본질적인 SRE에 집중하다보면 결국 **재난 엔지니어링**으로 귀결된다.



### 2. SRE를 하기 위해서 필요한 Attitude

- 이상적이고 멋진 도구가 아니라 **실질적인 문제 해결**에 주력하기 (Realist)
- 무식한 방법이더라도 끊임없이 **개선**하기 (Grit)
- 본인이 속한 **도메인**에 적절한 방법론을 적용하기 (Domain Specific)

